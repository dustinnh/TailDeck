# Promtail Configuration for TailDeck Development
#
# This configuration collects logs from local files and ships them to Loki.
# For Tailscale flow logs, you'll need to configure your Tailscale setup
# to output logs in a format that Promtail can ingest.

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Example: Scrape Tailscale logs from a file
  # Uncomment and adjust paths based on your Tailscale log setup
  # - job_name: tailscale
  #   static_configs:
  #     - targets:
  #         - localhost
  #       labels:
  #         job: tailscale
  #         __path__: /var/log/tailscale/*.log

  # Example: JSON-formatted flow logs
  # Configure your Tailscale node to output JSON flow logs to this path
  # - job_name: tailscale-flows
  #   static_configs:
  #     - targets:
  #         - localhost
  #       labels:
  #         job: tailscale
  #         type: flow
  #         __path__: /var/log/tailscale/flows/*.json
  #   pipeline_stages:
  #     - json:
  #         expressions:
  #           src_ip: src_ip
  #           dst_ip: dst_ip
  #           src_port: src_port
  #           dst_port: dst_port
  #           protocol: protocol
  #           bytes: bytes
  #           action: action
  #     - labels:
  #         src_ip:
  #         dst_ip:
  #         protocol:
  #         action:

  # Development: Scrape sample log file for testing
  - job_name: sample-flows
    static_configs:
      - targets:
          - localhost
        labels:
          job: tailscale
          type: flow
          __path__: /var/log/sample-flows.log
    pipeline_stages:
      - json:
          expressions:
            src_ip: src_ip
            dst_ip: dst_ip
            protocol: protocol
            action: action
      - labels:
          src_ip:
          dst_ip:
          protocol:
          action:

  # System logs (for debugging)
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          __path__: /var/log/syslog
